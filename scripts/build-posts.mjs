import { readdirSync, readFileSync, writeFileSync } from 'fs';
import { join, basename } from 'path';
import { marked } from 'marked';
import { createHighlighter } from 'shiki';

const ROOT = new URL('..', import.meta.url).pathname;
const CONFIG_DIR = join(ROOT, 'content/config');
const POSTS_DIR = join(ROOT, 'content/posts');
const OUTPUT = join(ROOT, 'src/app/data/posts.ts');

function escapeHtml(s) {
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// marked extension: protect math delimiters and convert to \(...\) / \[...\]
const mathBlock = {
  name: 'mathBlock',
  level: 'block',
  start(src) { return src.match(/\$\$/)?.index; },
  tokenizer(src) {
    const match = src.match(/^\$\$([\s\S]+?)\$\$/);
    if (match) {
      return { type: 'mathBlock', raw: match[0], text: match[1].trim() };
    }
  },
  renderer(token) {
    return `<div class="math-display">\\[${escapeHtml(token.text)}\\]</div>\n`;
  },
};

const mathInline = {
  name: 'mathInline',
  level: 'inline',
  start(src) { return src.match(/\$/)?.index; },
  tokenizer(src) {
    const match = src.match(/^\$([^\$\n]+?)\$/);
    if (match) {
      return { type: 'mathInline', raw: match[0], text: match[1] };
    }
  },
  renderer(token) {
    return `\\(${escapeHtml(token.text)}\\)`;
  },
};

// Collect languages used across all posts for Shiki
function collectLangs(posts) {
  const langs = new Set();
  for (const md of posts) {
    for (const match of md.matchAll(/```(\w+)/g)) {
      langs.add(match[1]);
    }
  }
  return [...langs];
}

async function main() {
  const configFiles = readdirSync(CONFIG_DIR)
    .filter(f => f.endsWith('.json'))
    .sort();

  const rawPosts = configFiles.map(file => {
    const slug = basename(file, '.json');
    const meta = JSON.parse(readFileSync(join(CONFIG_DIR, file), 'utf-8'));
    const md = readFileSync(join(POSTS_DIR, `${slug}.md`), 'utf-8');
    return { slug, meta, md };
  });

  // Create Shiki highlighter with all needed languages
  const langs = collectLangs(rawPosts.map(p => p.md));
  const highlighter = await createHighlighter({
    themes: ['github-light', 'github-dark'],
    langs: langs.length ? langs : ['text'],
  });

  // Configure marked with math extensions + Shiki code renderer
  marked.use({
    extensions: [mathBlock, mathInline],
    renderer: {
      code({ text, lang }) {
        const language = lang && highlighter.getLoadedLanguages().includes(lang) ? lang : 'text';
        return highlighter.codeToHtml(text, {
          lang: language,
          themes: { light: 'github-light', dark: 'github-dark' },
        });
      },
    },
  });

  const posts = rawPosts.map(({ slug, meta, md }) => {
    const contentHtml = marked.parse(md, { async: false });
    return { slug, ...meta, contentHtml };
  });

  posts.sort((a, b) => b.date.localeCompare(a.date));

  const output = `// Auto-generated by scripts/build-posts.mjs — do not edit manually
import { Post } from '../models/post.model';

export const POSTS: Post[] = ${JSON.stringify(posts, null, 2)};
`;

  writeFileSync(OUTPUT, output, 'utf-8');
  console.log(`Generated ${posts.length} posts → src/app/data/posts.ts`);
}

main();
